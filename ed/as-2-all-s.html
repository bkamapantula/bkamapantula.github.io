<!DOCTYPE html>
<meta charset="utf-8">
<title>States - women representation trends</title>
<style>

.bar.positive {
  fill: steelblue;
}

.bar.negative {
  fill: brown;
}

.axis text {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.parent {
  position: relative;
}
.svg {
  float: left;
}
.table{
  float: left;
}
</style>
<body>
<select id="states"></select>
<div class="parent">
    <div class="svg"></div>
    <div class="table"></div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="underscore-min.js"></script>
<script>

var margin = {top: 75, right: 10, bottom: 40, left: 40},
    width = 560 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

var y_toyear_width = width - 20,
    y_fromyear_width = 30;

var x = d3.scale.linear()
    .range([0, width-20]);

var y = d3.scale.ordinal()
    .rangeRoundBands([0, height], .2);

var y_fromyear = d3.scale.ordinal()
    .rangeRoundBands([0, height], 0.2);

var y_toyear = d3.scale.ordinal()
    .rangeRoundBands([0, height], 0.2);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("top");

var yAxisToYear = d3.svg.axis()
    .scale(y_toyear)
    .orient("right")
    .tickSize(0);

var yAxisFromYear = d3.svg.axis()
    .scale(y_fromyear)
    .orient("right")
    .tickSize(0);

var svg = d3.select(".svg").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

svg.append("text")
    .attr("x", 65)
    .attr("y", -35)
    .text("% Decrease | % Increase")

svg.append("text")
    .attr("x", -25)
    .attr("y", 400)
    .text("How to read: Women MLA representation decreased by 47% in 2014 compared to 2009")

svg.selectAll("text")
    .attr("font-size", "12px");

function loadTable(data, columns) {
    // http://jsfiddle.net/7WQjr/
    var table = d3.select(".table").append("table"),
        thead = table.append("thead"),
        tbody = table.append("tbody");

    // append the header row
    thead.append("tr")
        .selectAll("th")
        .data(columns)
        .enter()
        .append("th")
            .text(function(column) { return column; });

    // create a row for each object in the data
    var rows = tbody.selectAll("tr")
        .data(data)
        .enter()
        .append("tr");

    // create a cell in each row for each column
    var cells = rows.selectAll("td")
        .data(function(row) {
            return columns.map(function(column) {
                return {column: column, value: row[column]};
            });
        })
        .enter()
        .append("td")
            .text(function(d) { return d.value; });
    
    return table;
}

var nest = d3.nest()
    .key(function(d) {
        return d.State;
    });

function drawAxes(data) {
  x.domain(d3.extent(data, function(d) { return d.value; })).nice(); 
  y.domain(data.map(function(d) { return d['Next year']; }));
  y_toyear.domain(data.map(function(d) { return d['Next year']; }));
  y_fromyear.domain(data.map(function(d) { return d['Previous year']; }));
}

d3.csv("as_q_2_all_states_extra_cols.csv", type, function(error, data) {
  var dataByState = nest.entries(data);

  $("select#states").on("change", function() {
    var selectedStateKey = $("select").val();

    if(selectedStateKey) {

        if($(".table").length) {
            $(".table").empty();
        }

        if($("svg").length) {
            d3.selectAll(".bar").remove();
            d3.selectAll(".y.axis").remove();
            d3.selectAll(".x.axis").remove();
        }

        var table = loadTable(dataByState[selectedStateKey].values, ["Previous year", "Next year", "Previous #MLAs", "Next #MLAs"]);

      // dataByState[0].values
      drawAxes(dataByState[selectedStateKey].values);

      svg.append("g")
        .attr("class", "y axis")
        .attr("transform", "translate(" + y_toyear_width + ", 0)")
        .call(yAxisToYear);

      svg.append("g")
        .attr("class", "y axis")
        .attr("transform", "translate(-" + y_fromyear_width + ", 0)")
        .call(yAxisFromYear);

      // removes lines from y axis
      d3.selectAll("path").remove();

      svg.selectAll(".bar")
          .data(dataByState[selectedStateKey].values)
        .enter().append("rect")
          .attr("class", function(d) { return d.value < 0 ? "bar negative" : "bar positive"; })
          .attr("x", function(d) { return x(Math.min(0, d.value)); })
          .attr("y", function(d) { return y(d['Next year']); })
          .attr("width", function(d) { return Math.abs(x(d.value) - x(0)); })
          .attr("height", y.rangeBand());

      svg.append("g")
          .attr("class", "x axis")
          .call(xAxis);

      svg.append("g")
          .attr("class", "y axis")
        .append("line")
          .attr("x1", x(0))
          .attr("x2", x(0))
          .attr("y2", height);

      $(".table").css("font-size", "12px");
    }
  });
});

function type(d) {
  d.value = +d.value;
  return d;
}

</script>
<script>
    $(document).ready(function() {
        var states = ['Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar', 'Chhattisgarh', 'Delhi', 'Goa', 'Gujarat', 'Haryana', 'Himachal Pradesh', 'Jammu Kashmir', 'Jharkhand', 'Karnataka', 'Kerala', 'Madhya Pradesh', 'Maharashtra', 'Manipur', 'Meghalaya', 'Mizoram', 'Orissa', 'Pondicherry', 'Punjab', 'Rajasthan', 'Sikkim', 'Tamil Nadu', 'Tripura', 'Uttar Pradesh', 'Uttarakhand', 'West Bengal'];

        $("#states").append('<option value="state">Select state</option>');
        for(iter=0; iter<states.length; iter++) {
            $("#states").append('<option value="' + iter + '">' + states[iter] + '</option>');
        }

    });
</script>

